<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>A Tor Proxy in a Raspberry Pi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Marina von Steinkirch">

    <!-- Le styles -->
    <link rel="stylesheet" href="./theme/css/bootstrap.dark.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 11pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-4 {
        font-size: 8pt;
     }
     }
    </style>
    <link href="./theme/css/bootstrap-responsive.dark.css" rel="stylesheet">
    <link href="./theme/css/font-awesome.css" rel="stylesheet">
    <link href="./theme/css/pygments.css" rel="stylesheet">


    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="./theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="./theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">

    <link href="./feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="chmod +x singularity.sh ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="./index.html">chmod +x singularity.sh </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>

                          <ul class="nav pull-right">
                                <li><a href="./authors.html">Who is this Replicant</a></li>
                                <li><a href="./archives.html">Old Musing</a></li>
                                <li>
                                      <a href="https://github.com/bt3gl">The Language Within
                                      <!--<i class="icon-github-sign icon-large" ></i>-->
                                      </a></li>
                                <li><a href="http://bt3gl.github.io/projects_page/index.html">Bygone Playful Times
                                      </a></li>
                                <li><a href="http://www.astro.sunysb.edu/steinkirch/index.html">Universe and Everything Else
                                     </a></li>
                          
                          
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to A Tor Proxy in a Raspberry Pi">
                                        A Tor Proxy in a Raspberry Pi
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<abbr class="published" title="2015-03-29T00:00:00-04:00">
      Sun 29 March 2015 </abbr>

<span class="label"> Category</span>
<a href="./category/devops.html"><i class="icon-folder-open"></i>DevOps</a>


</footer><!-- /.post-info -->                </div>
                <p><img alt="tor" height="250px" src="./cyberpunk/tor.jpg" width="350px"></p>
<p>In this tutorial I walk through all the steps to setup a Tor proxy in a Raspberry Pi (Model B). This work was based on some of tutorials from Adafruit.</p>
<h1>Setting Up a Raspberry Pi</h1>
<h2>Installing an Operating System in the SD card</h2>
<p><a href="http://www.raspberrypi.org/help/noobs-setup">You can either install NOOBS and then choose your OS</a>.</p>
<p><a href="http://fedoraproject.org/wiki/FedoraARMInstaller">Or you can download the Fedora ARM Installer and the OS image you prefer</a>.</p>
<h2>Network Setup</h2>
<p>The easiest way is to connect your Pi in the network is through an ethernet interface. Connecting the cable should be allow the connection directly as long as your network router allows DHCP.</p>
<p>In addition, you can also setup a wireless connect, which requires your router to be broadcasting the SSID. At Raspbian, there is a WiFi configuration icon. Type wlan0 adapter and scan. After connecting in your network you will also be able to see the IP of your Pi.</p>
<h2>Input/Output Setup</h2>
<p>The easiest way to connect to your Pi is by a HDMI cable to a monitor and an USB keyboard. Another options is through a console cable or a SSH connection.</p>
<h2>Connection through a Console Cable (3.3V logic levels)</h2>
<p>The connections are to the outside pin connections of the GPIO header:</p>
<div class="highlight"><pre><span></span>The red lead should be connected to 5V.
The black lead to GND,
The white lead to TXD.
The green lead to RXD.
If the serial lead (red) is connected, do not attach the Pi&#39;s USB power adapter. 
</pre></div>


<p>In Linux you can use screen:</p>
<div class="highlight"><pre><span></span>$ sudo apt-get install screen
$ sudo screen /dev/ttyUSB0 <span class="m">115200</span>
</pre></div>


<p>In Windows, you can use a terminal emulation such as Putty and the drivers from this (link)[http://www.prolific.com.tw/US/ShowProduct.aspx?p_id=225&amp;pcid=41]. Verify the number of the COM serial port in the Device manager and connect with speed 115200.</p>
<h2>SSH Connection</h2>
<p>You need to enable SSH in the Pi:</p>
<div class="highlight"><pre><span></span>$ sudo raspi-config
</pre></div>


<p>Find the Pi's IP by:</p>
<div class="highlight"><pre><span></span>$ sudo ifconfig
</pre></div>


<p>From your Linux PC (using "pi" as user):</p>
<div class="highlight"><pre><span></span>$ sudo PI-IP -l pi
</pre></div>


<p>You can (should) set RSA keys. In a terminal session on the Linux client enter:</p>
<div class="highlight"><pre><span></span>$ mkdir ~/.ssh
$ chmod <span class="m">700</span> ~/.ssh
$ ssh-keygen -t rsa
</pre></div>


<p>Now copy the public key over to the Pi by typing in the client:</p>
<div class="highlight"><pre><span></span>$ ssh-copy-id &lt;userid&gt;@&lt;hostname or ip address&gt;
</pre></div>


<h2>Setting up a Wi-Fi Access Point</h2>
<p>You need an ethernet cable and a WiFi adapter. First, check if you see the wlan0 (the WiFi) module:</p>
<div class="highlight"><pre><span></span>$ ifconfig -a 
</pre></div>


<h3>DHCP Server Configuration</h3>
<p>Install the software that will act as the hostap (host access point):</p>
<div class="highlight"><pre><span></span>$ sudo apt-get install hostapd isc-dhcp-server
</pre></div>


<p>If the Pi cannot get the apt-get repositories:</p>
<div class="highlight"><pre><span></span>$ sudo apt-get update 
</pre></div>


<p>Edit <code>/etc/networks/interfaces</code>:</p>
<div class="highlight"><pre><span></span>auto lo

iface lo inet loopback
iface eth0 inet dhcp

allow-hotplug wlan0

iface wlan0 inet static
  address 192.168.42.1
  netmask 255.255.255.0
</pre></div>


<p>Then edit the DHCP server configuration file, <code>/etc/dhcp/dhcpd.conf</code>:</p>
<div class="highlight"><pre><span></span>subnet 192.168.42.0 netmask 255.255.255.0 {
range 192.168.42.10 192.168.42.50;
option broadcast-address 192.168.42.255;
option routers 192.168.42.1;
default-lease-time 600;
max-lease-time 7200;
option domain-name &quot;local&quot;;
option domain-name-servers 8.8.8.8, 8.8.4.4;
}
</pre></div>


<p>Now, add the bellow line to <code>/etc/default/isc-dhcp-server</code>:</p>
<div class="highlight"><pre><span></span>INTERFACES=&quot;wlan0&quot; 
</pre></div>


<p>Restart the network:</p>
<div class="highlight"><pre><span></span>$ sudo /etc/init.d/networking restart
</pre></div>


<h3>IP Forwarding</h3>
<p>Enable IP forwarding and setting up NAT to allow multiple clients to connect to the WiFi and have all the data 'tunneled' through the single Ethernet IP:</p>
<div class="highlight"><pre><span></span>$ sudo <span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward
$ sudo nano /etc/sysctl.conf
</pre></div>


<p>Uncomment the next line to enable packet forwarding for IPv4:</p>
<div class="highlight"><pre><span></span>net.ipv4.ip_forward=1
</pre></div>


<p>And update:</p>
<div class="highlight"><pre><span></span>sudo sh -c &quot;echo 1 &gt; /proc/sys/net/ipv4/ip_forward&quot;
</pre></div>


<h3>Firewall Configuration</h3>
<p>We insert an iptables rules to allow NAT (network address translation):</p>
<div class="highlight"><pre><span></span>$ iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
$ iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
$ iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
</pre></div>


<p>To make the above true in every reboot:</p>
<div class="highlight"><pre><span></span>$ sudo sh -c <span class="s2">&quot;iptables-save &gt; /etc/iptables.ipv4.nat&quot;</span>
</pre></div>


<p>For additional security (it blocks access from RFC 1918 subnets on your internet (eth0) interface as well as ICMP (ping) packets and ssh connections.):</p>
<div class="highlight"><pre><span></span>$ sudo iptables -A INPUT -s <span class="m">192</span>.168.0.0/24 -i eth0 -j DROP
$ sudo iptables -A INPUT -s <span class="m">10</span>.0.0.0/8 -i eth0 -j DROP
$ sudo iptables -A INPUT -s <span class="m">172</span>.16.0.0/12 -i eth0 -j DROP
$ sudo iptables -A INPUT -s <span class="m">224</span>.0.0.0/4 -i eth0 -j DROP
$ sudo iptables -A INPUT -s <span class="m">240</span>.0.0.0/5 -i eth0 -j DROP
$ sudo iptables -A INPUT -s <span class="m">127</span>.0.0.0/8 -i eth0 -j DROP
$ sudo iptables -A INPUT -i eth0 -p tcp -m tcp --dport <span class="m">22</span> -j DROP
$ sudo iptables -A INPUT -i eth0 -p icmp -m icmp --icmp-type <span class="m">8</span> -j DROP
$ sudo iptables-save &gt; /etc/iptables.up.rules
</pre></div>


<p>If you want to see how many packets your firewall is blocking:</p>
<div class="highlight"><pre><span></span>$ iptables -L -n -v
</pre></div>


<p>If your eth0 still shows a private address, it probably didn't renew when you moved it to your modem. Fix this by running:</p>
<div class="highlight"><pre><span></span>$ sudo ifdown eth0 <span class="o">&amp;&amp;</span> sudo ifup eth0
</pre></div>


<h2>Access Point Configuration</h2>
<p>Configure Access Point with hostpad, editing <code>/etc/hostapd/hostapd.conf</code>:</p>
<div class="highlight"><pre><span></span>interface=wlan0
driver=rtl871xdrv
ssid=Pi_AP
hw_mode=g
channel=6
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=Raspberry
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
</pre></div>


<p>Now we will tell the Pi where to find this configuration file in /etc/default/hostapd:</p>
<div class="highlight"><pre><span></span>DAEMON_CONF=&quot;/etc/hostapd/hostapd.conf&quot;
</pre></div>


<p>And start the access point by running hostpad:</p>
<div class="highlight"><pre><span></span>$ hostapd -d /etc/hostapd/hostapd.conf
</pre></div>


<p>To start automatically, add the command to <code>/etc/rc.local</code>:</p>
<div class="highlight"><pre><span></span>$ hostapd -B /etc/hostapd/hostapd.conf
</pre></div>


<h3>Logs and Status</h3>
<p>To see the system log data, run in the Pi:</p>
<div class="highlight"><pre><span></span>$ tail -f /var/log/syslog
</pre></div>


<p>You can always check the status of the host AP server and the DHCP server with:</p>
<div class="highlight"><pre><span></span>$ sudo service hostapd status
$ sudo service isc-dhcp-server status
</pre></div>


<h3>Setting up a Daemon</h3>
<p>Now that we know it works, we can set it up as a 'daemon' (a program that will start when the Pi boots):</p>
<div class="highlight"><pre><span></span>$ sudo service hostapd start 
$ sudo service isc-dhcp-server start
</pre></div>


<p>To start the daemon services. Verify that they both start successfully (no 'failure' or 'errors')</p>
<div class="highlight"><pre><span></span>$ sudo update-rc.d hostapd <span class="nb">enable</span> 
$ sudo update-rc.d isc-dhcp-server <span class="nb">enable</span>
</pre></div>


<h3>Removing WPA-Supplicant</h3>
<p>Depending on your distribution, you may need to remove WPASupplicant. Do so by running this command:</p>
<div class="highlight"><pre><span></span>sudo mv /usr/share/dbus-1/system-services/fi.epitest.hostap.WPASupplicant.service ~/
</pre></div>


<h2>Setting up the Tor Proxy</h2>
<p>You now have a wirelesses access point in your Pi. To make it a Tor proxy, first install Tor:</p>
<div class="highlight"><pre><span></span>$ sudo apt-get install tor
</pre></div>


<p>Then edit the Tor config file at <code>/etc/tor/torrc</code>:</p>
<div class="highlight"><pre><span></span>Log notice file /var/log/tor/notices.log
VirtualAddrNetwork 10.192.0.0/10
AutomapHostsSuffixes .onion,.exit
AutomapHostsOnResolve 1
TransPort 9040
TransListenAddress 192.168.42.1
DNSPort 53
DNSListenAddress 192.168.42.1
</pre></div>


<p>Change the IP routing tables so that connections via the WiFi interface (wlan0) will be routed through the Tor software. To flush the old rules from the IP NAT table do:</p>
<div class="highlight"><pre><span></span>$ sudo iptables -F
$ sudo iptables -t nat -F
</pre></div>


<p>Add the iptables, to be able to ssh:</p>
<div class="highlight"><pre><span></span>$ sudo iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport <span class="m">22</span> -j REDIRECT --to-ports <span class="m">22</span> 
</pre></div>


<p>To route all DNS (UDP port 53) from interface wlan0 to internal port 53 (DNSPort in our torrc):</p>
<div class="highlight"><pre><span></span>$ sudo iptables -t nat -A PREROUTING -i wlan0 -p udp --dport <span class="m">53</span> -j REDIRECT --to-ports <span class="m">53</span>
</pre></div>


<p>To route all TCP traffic from interface wlan0 to port 9040 (TransPort in our torrc):</p>
<div class="highlight"><pre><span></span>$ sudo iptables -t nat -A PREROUTING -i wlan0 -p tcp --syn -j REDIRECT --to-ports <span class="m">9040</span> 
</pre></div>


<p>Check that the iptables are right with:</p>
<div class="highlight"><pre><span></span>$ sudo iptables -t nat -L
</pre></div>


<p>If everything is good, we'll save it to our old NAT save file:</p>
<div class="highlight"><pre><span></span>$ sudo sh -c <span class="s2">&quot;iptables-save &gt; /etc/iptables.ipv4.nat&quot;</span>
</pre></div>


<p>Next we'll create our log file (handy for debugging) with:</p>
<div class="highlight"><pre><span></span>$ sudo touch /var/log/tor/notices.log
$ sudo chown debian-tor /var/log/tor/notices.log
$ sudo chmod <span class="m">644</span> /var/log/tor/notices.log
</pre></div>


<p>Check it with:</p>
<div class="highlight"><pre><span></span>$ ls -l /var/log/tor
</pre></div>


<p>Finally, you can start the Tor service manually:</p>
<div class="highlight"><pre><span></span>$ sudo service tor start
</pre></div>


<p>And make it start on boot:</p>
<div class="highlight"><pre><span></span>$ sudo update-rc.d tor <span class="nb">enable</span>
</pre></div>


<p>That's it! Browser safe!</p>
<hr>
<p>Enjoy! This article was originally posted <a href="https://coderwall.com/p/m3excg/a-tor-proxy-in-a-raspberry-pi">here</a>.</p>
                </div><!-- /.entry-content -->
        </article>
</section>
        </div><!--/span-->


      </div><!--/row-->



      <footer>
        <address id="about">

        </address><!-- /#about -->

      </footer>

    </div><!--/.fluid-container-->


    <script src="./theme/js/jquery-1.7.2.min.js"></script>
    <script src="./theme/js/bootstrap.min.js"></script>
  </body>
</html>